<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="format-detection" content="telephone=no"/>
  <meta name="msapplication-tap-highlight" content="no"/>
  <meta name="viewport"
        content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width"/>
  <!-- This is a wide open CSP declaration. To lock this down for production, see below. -->
  <meta http-equiv="Content-Security-Policy"
        content="style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval';">
  
  <!-- Good default declaration:
  * https://ssl.gstatic.com is required only on Android and is needed for TalkBack to function properly
  * Disables use of eval() and inline scripts in order to mitigate risk of XSS vulnerabilities. To change this:
      * Enable inline JS: add 'unsafe-inline' to default-src
      * Enable eval(): add 'unsafe-eval' to default-src
  -->
  <!--<meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: 'unsafe-inline' https://ssl.gstatic.com; style-src 'self' 'unsafe-inline'; media-src *" />-->
  
  <link rel="stylesheet" href="css/vendor/bootstrap/bootstrap.min.css">
  <!--<link rel="stylesheet" type="text/css" href="css/vendor/index.css"/>-->
  <link rel="stylesheet" type="text/css" href="css/vendor/jquery.mobile-1.4.5.min.css">
  <link rel="stylesheet" href="css/vendor/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="css/vendor/animate/animate.css">
  <link rel="stylesheet" type="text/css" href="css/custom.css">
  
  
  <script type="text/javascript" src="js/jquery-2.2.4.min.js"></script>
  <script type="text/javascript" src="js/jquery.mobile-1.4.5.min.js"></script>
  <script type="text/javascript" src="js/bootstrap/bootstrap.min.js"></script>
  
  <title>Quizr</title>
</head>

<body>
<div id="main-screen" class="" data-role="page">
</div>
<script type="text/javascript" charset="utf-8" src="cordova.js"></script>
<script>
  // Wait for device API libraries to load
  //
  document.addEventListener("deviceready", onDeviceReady, false);
  document.addEventListener("backbutton", onBackButton, false);

  // Handle the logic for the back-button for entire app here, since the event is attached to the document
  function onBackButton() {
    var pageName = $(":mobile-pagecontainer").pagecontainer("getActivePage").attr("id");
    var isTokenSet = window.localStorage.getItem("user-token");
    if (pageName === "main-screen") {
      navigator.app.exitApp();
    } else if (pageName === "login-screen") {
      navigator.app.exitApp();
    } else if (pageName === "home-screen" && isTokenSet) {
      navigator.app.exitApp();
    }
    else {
      navigator.app.backHistory();
    }

  }

  // device APIs are available
  function onDeviceReady() {
    // start showing splash screen
    navigator.splashscreen.show();

    // validate the token with backend (expired or not)
    var authToken = localStorage.getItem('user-token');
    if (!authToken) { // if the token doesn't even exist

      // then show login screen before even sending request to validate the token
      authenticateUser("login.html");
    } else {

      $.ajax('https://programming-quiz-learning-app.herokuapp.com/user-profile', {headers: {"x-access-token": authToken}})
        .done(function (data) {

          if (data.success) { // if token is not expired

            // then show home screen
            authenticateUser("home.html");

          } else { // if expired

            // then show login screen
            authenticateUser("login.html");

          }
        });
    }

    function authenticateUser(pageName) {
      // hide splash screen before showing any other screen (login or home screen)
      setTimeout(function () {
        navigator.splashscreen.hide();
      }, 3000);

      $(':mobile-pagecontainer').pagecontainer("change", pageName, {
        role: "page",
        transition: "fade",
        changeHash: true,
        reverse: true,
        showLoadMsg: true
      })
    }
  }
</script>
</body>
</html>